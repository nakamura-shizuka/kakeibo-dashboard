# ANTIGRAVITY

このドキュメントは、家計簿アプリ開発プロジェクトにおける**最上位の全体設計およびルール**を定義するものです。AIアシスタントは本ドキュメント（要件や制約）を順守し、逸脱する実装を行わないこと。

## 1. プロジェクトの目的とコアバリュー

*   **目的**: ユーザーとそのパートナーが、家計のお金の流れ（収支）を完全に把握し、「どこが無駄遣いなのか」を特定して改善できる「バランスの良い家計」を作るための完全個人用ダッシュボードを構築する。
*   **コアバリュー（解決したい課題）**:
    *   **持続可能性（挫折しない）**: 既存アプリ（MoneyForward等）で発生していた「連携切れ・再認証の手間」「不明項目の手打ち」によるフラストレーションをゼロにする。
    *   **コストゼロ維持**: サブスクリプション費用などのランニングコストをかけず、Googleの無料インフラの範囲内で完結させる。
    *   **認知の最適化**: 「今月の残り予算はいくらか」「何に（カテゴリ）いくら使っているか」がスマホから1秒でわかるUI。

## 2. システム構成（完全無料・高耐久アーキテクチャ）

外部の有料API等に一切依存しない、以下のアプローチを採用する。

*   **データベース（DB）**: Google Spreadsheet（全データの中央集権的マスター）
*   **バックエンド処理**: Google Apps Script (GAS)
*   **フロントエンド（UI）**: スマホ向けWebアプリ (HTML/CSS/JS + GAS Web Apps ＋ 必要に応じてLooker Studio)

## 3. データ収集戦略（入力負荷の極小化）

データの収集は、以下の3つのレイヤー（自動・半自動・手動）を組み合わせて実現する。

### レイヤー1：完全自動（クレジットカード）
クレジットカードの利用分については、「利用通知メール」をGASがGmailから定期的に取得・解析し、スプレッドシートに自動記帳する。

*   **対象**: 三井住友カード、PayPayカード（メール件名・本文仕様にあわせた専用パーサーを実装）
*   **仕様**: 各社のメールフォーマット（件名、送信元、本文構造）に合わせて正規表現等で「日付」「金額」「利用店（摘要）」を抽出し、DBへ追記。
*   **特記事項**: クレジットカードの利用通知は金額と摘要が本文に含まれるため自動化のメインエンジンとなる。過去データの一括取り込み機能もサポートする。

### レイヤー2：定期自動化（固定費）と柔軟な修正機能
毎月決まった日に決まった額が動く「固定費」や「給与入金」については、GASの定期実行（トリガー）を用いて自動でDBへ書き込む。

*   **対象**: 家賃、光熱費、サブスクリプション、給与など、全ての銀行口座における定例的な入出金
*   **基本仕様**: 「毎月〇日に、〇〇という名目で、〇〇円を計上する」というルールセットをGAS内に持ち、自動実行する。
*   **修正機能（オーバーライド）**: 給与の変動や光熱費の確定など、自動実行された金額にズレが生じた場合、**後からLINEのトーク画面で「今月の給与 300000」「今月の電気代 8000」と送るだけで、対象の固定費レコードの金額を上書き修正できる機能**を持たせる。これにより、自動化の恩恵を受けつつ完璧な正確性を担保する。

### レイヤー3：手動補完（都度入力 ＆ 一括入力）
自動化できない変動費や、イレギュラーな支出（銀行からの引き出し等）は、摩擦のない方法でユーザーが補完する。

*   **都度入力（LINE Bot連携）**: 現金払い、PayPay決済、その他アプリ決済など。LINEのトーク画面から「品名 金額」と送るだけでDBに即時反映させる。
*   **一括アップロード（CSV等）**: 各銀行の残高や細かい入出金をすり合わせるため、月1回などの頻度で手動またはファイルアップロード機能を用いてDBを補正する。

## 4. 開発ロードマップ（段階的MVPアプローチ）

本プロジェクトは「確実に動くものを少しずつ作る」アプローチをとる。

*   **Phase 1〜3: 基盤構築と初期可視化（完了済）**
    *   DB環境（スプレッドシート）と自動収集プログラムの構築
    *   LINEからの手動入力基盤の実装、初期ダッシュボードの開通
*   **Phase 4〜5: UI/UX刷新と月次ナビゲーション（完了済）**
    *   「Kawaii & Clean」デザインの適用、D3.jsによるサンキー図等の動的実装
    *   過去データの振り返り機能と全履歴からの繰越金額自動計算
*   **Phase 6: ダッシュボード完全化とプレミアム機能拡張（完了済）**
    *   ダッシュボード上からの直接入力・修正機能（MVP拡張）
    *   カテゴリ・固定費ルールのカスタマイズUI機能
    *   年間収支レポート（貯蓄推移グラフ）の可視化
    *   複数口座・資産残高（現金・カード等）の個別管理
    *   予算アラート機能（GAS定期監視とLINEへの自動警告通知）
    *   Gemini API連携による定期自動分析・アドバイス機能（LINE通知 / ダッシュボード表示）
*   **Phase 7: 自動機帳基盤の確立（レイヤー1）と入力UI拡張（完了済）**
    *   2月分のテストデータの一括クリア
    *   Gmail連携（三井住友カード・PayPayカード）と過去データの一括取り込み
    *   定期実行トリガーによる最新カード利用の自動記帳（GAS）
    *   ダッシュボード入力モーダルへの「収入」「貯蓄（口座移動）」タブの実装
*   **Phase 8: AIによる客観的家計分析と浪費検知（進行中）**
    *   **キャラクター**: 感情を排し、冷静・客観的なデータ分析のみを行う。
    *   **分析観点**: 週次・月次・過去月との比較。予算や過去実績から「浪費（使いすぎ）ポイント」を徹底的に洗い出す。
    *   **通知・表示**: 毎週土曜夕方/毎月1日朝のLINE自動通知 ＆ ダッシュボードからの「即時分析」ボタン実装。

## 5. 運用ルール（AIの行動指針）

*   **破壊的変更の禁止**: DBのスキーマ変更や、既存データの広範囲な更新・削除を伴う処理を行う場合は、必ず事前にユーザーへ仕様と影響範囲を提示し、「y/n」の承認を得ること。
*   **セキュリティファースト**: GASを使用する際、認証情報（LINEチャネルアクセストークン等）はスクリプトプロパティに保存し、コードに直書きしないこと。

---
*Created by Antigravity (Phase 1 準備完了)*
