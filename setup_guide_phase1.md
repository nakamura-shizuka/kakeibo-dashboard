# みえる化家計簿 - セットアップ手順（Phase 1）

このドキュメントは、家計簿の土台となる「プログラム（GAS）」を立ち上げ、すでに作成済みの「LINE Bot」と紐付けるための手順書です。

---

## 💡 【事前知識】LINE APIの2つの「鍵」について

ご指摘いただいた「チャネルシークレット」は**「悪意のある人が勝手に家計簿に入力しないように守る（本人確認の）鍵」**として非常に重要なので、今回セキュリティ対策としてプログラムに組み込みました！素晴らしいご指摘ありがとうございます。

一方で、GASからLINE側へ「登録しました！」という**「返信のメッセージ」を送るためには、LINEの仕様上「チャネルアクセストークン」が必要**になります。
（※シークレットは**「受信時の門番」**、アクセストークンは**「送信時の切符」**という役割分担になっています。）

ですので、今回は**「両方の鍵」**をGASに登録して、完璧に安全なシステムを作ります！

---

## ステップ1: GAS（プログラム）の立ち上げ

1.  Googleを開き、[Google Apps Script (GAS) ダッシュボード](https://script.google.com/home) にアクセスします。
2.  左上の **「＋ 新しいプロジェクト」** をクリックします。
3.  画面左上の「無題のプロジェクト」をクリックし、「みえる化家計簿システム」など好きな名前に変更します。
4.  最初から入っている `function myFunction() { ... }` をすべて消して、同じフォルダにある `gas_code_initial.js` の中身をすべて貼り付けます。
5.  キーボードの `Ctrl + S` （Macは `Cmd + S`）を押して保存します。

---

## ステップ2: 魔法の自動作成プログラムを実行する

この処理を実行すると、Googleドライブに「みえる化家計簿DB」というスプレッドシート（DB）が自動作成されます。

1.  画面上部の「実行」ボタンのすぐ左にあるドロップダウンから **「createDatabase」** を選択します。
2.  **「実行」ボタン** をクリックします。
3.  「承認が必要です」という画面が出たら、「権限を確認」＞ご自身のアカウントを選択＞左下の「詳細」＞「みえる化家計簿システム（安全ではないページ）に移動」＞「許可」の順に進みます。
4.  画面下の実行ログに「✨ 完 成 ✨」と表示されたら成功です！

---

## ステップ3: 2つの「鍵」の取得と登録

1.  [LINE Developers](https://developers.line.biz/ja/) にアクセスし、作成済みのチャネルを開きます。
2.  「セキュリティの鍵」である **【チャネルシークレット】** をコピーします。（「チャネル基本設定」タブの下の方にあります）
3.  「送信用（返信用）の切符」である **【チャネルアクセストークン】** をコピーします。（「Messaging API設定」タブの一番下にあります）
4.  GAS の画面に戻り、左側メニューの **歯車アイコン（プロジェクトの設定）** をクリックし、一番下までスクロールします。
    *   ※「スクリプト プロパティ」に `SPREADSHEET_ID` がすでに入っている状態です。
5.  **[スクリプト プロパティを追加]** をクリックし、以下の2つを追加して [プロパティを保存] します。
    *   **プロパティ**: `LINE_CHANNEL_SECRET` （値：ステップ2でコピーした文字列）
    *   **プロパティ**: `LINE_ACCESS_TOKEN` （値：ステップ3でコピーした文字列）

---

## ステップ4: デプロイとWebhookの設定

1.  GAS画面右上の **青い「デプロイ」ボタン** を押し、「新しいデプロイ」を選択します。
    *   **種類の選択**: 「ウェブアプリ」（歯車アイコンから選択）
    *   **アクセスできるユーザー**: **「全員」**（← **重要！ここを間違えると動きません**）
2.  デプロイボタンを押し、完了後に表示される **「ウェブアプリのURL」** （`https://script.google.com/.../exec`）をコピーします。
3.  LINE Developersの「Messaging API設定」タブを開きます。
4.  「Webhook設定」の **「Webhook URL」** に、コピーしたURLを貼り付けて保存します。（Webhookが「オン」になっていることも確認してください）
5.  「検証」ボタンを押します。（※下記「よくあるトラブル」も参照）
6.  Botに「ランチ 1200」と話しかけてみてください。「✅ 記録完了！」と返信が来たら、**開通大成功**です！

---

## ステップ5: コード更新時の再デプロイ手順

コードを修正した場合、**必ず「新しいバージョン」として再デプロイ**する必要があります。（※保存だけでは反映されません！）

1.  GASエディタで `gas_code_initial.js` の最新コードを貼り付けて保存します。
2.  画面右上の **「デプロイ」** ボタン → **「デプロイを管理」** をクリックします。
3.  右上の **鉛筆アイコン（✏️ 編集）** をクリックします。
4.  **「バージョン」** を **「新バージョン」** に変更します。
5.  「デプロイ」ボタンを押して完了です。

> ⚠️  **「新バージョン」に変更しないと、古いコードのまま動き続けます！** これが最もよくあるハマりポイントです。

---

## よくあるトラブルと対処法

### 🔸「302 Found」エラー（Webhook検証ボタン）
**→ 無視してOKです。** GASのWeb Appは、セキュリティ上の仕様でPOSTリクエストを内部リダイレクト（302）します。検証ボタンはこのリダイレクトに対応していないためエラーが出ますが、**実際のLINEメッセージ送受信は正常に動作します**。LINEのトーク画面からBotに直接メッセージを送って動作確認してください。

### 🔸「タイムアウト」エラー（Webhook検証ボタン）
**→ これもGAS特有の問題です。** GASの初回起動（コールドスタート）には数秒かかるため、検証ボタンのタイムアウト制限に引っかかることがあります。実際のメッセージ送信では問題になりにくいので、直接テストしてみてください。

### 🔸 Botにメッセージを送っても無反応
以下を順番に確認してください：
1.  デプロイが「新バージョン」で行われているか
2.  Webhook URLが正しいか（LINE Developersで確認）
3.  Webhookが「オン」になっているか
4.  スクリプトプロパティの値に余分なスペースや改行が入っていないか
