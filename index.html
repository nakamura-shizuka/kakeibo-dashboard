<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã¿ãˆã‚‹åŒ–å®¶è¨ˆç°¿</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* ===== ãƒªã‚»ãƒƒãƒˆ & ãƒ™ãƒ¼ã‚¹ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Kawaii & Clean ãƒ†ãƒ¼ãƒï¼ˆãƒ©ã‚¤ãƒˆãƒ‘ã‚¹ãƒ†ãƒ«ï¼‰ */
            --bg-primary: #FAFAFB;
            /* ã»ã‚“ã®ã‚Šã‚°ãƒ¬ãƒ¼ãŒã‹ã£ãŸç™½èƒŒæ™¯ */
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-card-hover: rgba(255, 255, 255, 1);
            --border-card: rgba(0, 0, 0, 0.04);
            --card-shadow: 0 8px 24px rgba(100, 110, 140, 0.08);
            /* æŸ”ã‚‰ã‹ã„ã‚·ãƒ£ãƒ‰ã‚¦ */

            --text-primary: #334155;
            /* ã‚¹ãƒ¬ãƒ¼ãƒˆç³»ã®æŸ”ã‚‰ã‹ã„é»’ */
            --text-secondary: #64748B;
            /* ä¸­é–“è‰²ã®ã‚°ãƒ¬ãƒ¼ */
            --text-muted: #94A3B8;
            /* è–„ã„ã‚°ãƒ¬ãƒ¼ */

            --accent: #FF8FAD;
            /* ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ”ãƒ³ã‚¯ï¼ˆãƒ¡ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ï¼‰ */
            --accent-light: #FFB3C6;
            /* æ˜ã‚‹ã„ãƒ”ãƒ³ã‚¯ */
            --accent-glow: rgba(255, 143, 173, 0.25);

            --danger: #FF7E7E;
            /* æŸ”ã‚‰ã‹ã„èµ¤ */
            --warning: #FFC074;
            /* æŸ”ã‚‰ã‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
            --safe-green: #6EE7B7;
            /* ãƒ‘ã‚¹ãƒ†ãƒ«ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³ */
            --income-green: #34D399;
            /* ã‚‚ã†å°‘ã—ã¯ã£ãã‚Šã—ãŸã‚°ãƒªãƒ¼ãƒ³ */

            /* D3.jsã‚„ã‚«ãƒ†ã‚´ãƒªç”¨ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --chart-1: #FF9CEE;
            /* ãƒ”ãƒ³ã‚¯ */
            --chart-2: #B28DFF;
            /* ãƒ‘ãƒ¼ãƒ—ãƒ« */
            --chart-3: #6EB5FF;
            /* ãƒ–ãƒ«ãƒ¼ */
            --chart-4: #85E3FF;
            /* æ°´è‰² */
            --chart-5: #AFF8D8;
            /* ãƒŸãƒ³ãƒˆ */
            --chart-6: #E7FFAC;
            /* ãƒ©ã‚¤ãƒ  */
            --chart-7: #FFF5BA;
            /* ã‚¤ã‚¨ãƒ­ãƒ¼ */
            --chart-8: #FFABAB;
            /* ã‚µãƒ¼ãƒ¢ãƒ³ */
        }

        /* GASãƒãƒŠãƒ¼ã€Œã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯...ã€ã‚’éè¡¨ç¤º */
        #top_nav,
        .apps-script-banner,
        div[role="banner"] {
            display: none !important;
        }

        body {
            /* æ—¥æœ¬èªã¯ä¸¸ã‚´ã‚·ãƒƒã‚¯ã€æ•°å­—ã¯ä¸¸ã¿ã®ã‚ã‚‹è‹±æ›¸ä½“ */
            font-family: 'Nunito', 'M PLUS Rounded 1c', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 30px;
        }

        /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(180deg, rgba(250, 250, 251, 0.95) 60%, transparent);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 16px 20px 24px;
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 800;
            /* ã‚ˆã‚Šã½ã£ã¦ã‚Šã—ãŸå¤ªã• */
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header .month-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-top: 2px;
        }

        .refresh-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            border: none;
            background: #fff;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            /* ãƒœã‚¿ãƒ³ã«ã‚‚å½± */
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* ã½ã‚ˆã‚“ã¨ã—ãŸå‹•ã */
        }

        .refresh-btn:active {
            transform: scale(0.9) rotate(90deg);
            background: var(--bg-primary);
        }

        /* ===== ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ===== */
        .container {
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* ã‚«ãƒ¼ãƒ‰é–“éš”ã‚’å°‘ã—åºƒã’ã‚‹ */
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-card);
            border-radius: 24px;
            /* ã‚ˆã‚Šä¸¸ã */
            padding: 24px;
            box-shadow: var(--card-shadow);
            /* ãµã‚“ã‚ã‚Šã‚·ãƒ£ãƒ‰ã‚¦ */
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s;
            opacity: 0;
            transform: translateY(20px);
        }

        .card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .card-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .icon {
            font-size: 1.2rem;
            background: var(--bg-primary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        /* ===== æ”¯å‡ºã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ ===== */
        .summary-amount {
            font-size: 2.5rem;
            /* ã¡ã‚‡ã£ã¨å¤§ãã */
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .summary-amount .currency {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-right: 4px;
        }

        .summary-budget {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .progress-bar {
            height: 16px;
            /* ä½™è£•ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«å¤ªã */
            background: rgba(0, 0, 0, 0.04);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.02);
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 0;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 30px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5));
            border-radius: 8px;
        }

        .progress-fill.safe {
            background: linear-gradient(90deg, #A7F3D0, var(--safe-green));
            box-shadow: 0 0 12px rgba(110, 231, 183, 0.4);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #FDE68A, var(--warning));
            box-shadow: 0 0 12px rgba(255, 192, 116, 0.4);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #FECACA, var(--danger));
            box-shadow: 0 0 12px rgba(255, 126, 126, 0.4);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        /* ===== åå…¥ãƒ»æ®‹é«˜ãƒŸãƒ‹ã‚«ãƒ¼ãƒ‰ ===== */
        .mini-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .mini-card {
            background: #fff;
            /* ç‹¬ç«‹ã—ãŸã‚«ãƒ¼ãƒ‰æ„Ÿã‚’å‡ºã™ */
            border: 1px solid var(--border-card);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .mini-card .mini-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .mini-card .mini-value {
            font-size: 1.25rem;
            font-weight: 800;
        }

        .mini-card .mini-value.green {
            color: var(--income-green);
        }

        .mini-card .mini-value.accent {
            color: var(--accent);
        }

        /* ===== ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰ ===== */
        .chart-container {
            width: 100%;
            height: 240px;
            /* å°‘ã—å¤§ãã */
            position: relative;
        }

        .category-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-card);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-amount {
            color: var(--text-primary);
            font-weight: 700;
        }

        /* ===== ã‚µãƒ³ã‚­ãƒ¼ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ  ===== */
        .sankey-container {
            width: 100%;
            height: 260px;
        }

        /* ===== å–å¼•å±¥æ­´ ===== */
        .record-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .record-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #fff;
            border-radius: 16px;
            border: 1px solid var(--border-card);
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.01);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }

        .record-icon {
            width: 44px;
            /* ã‚¿ãƒƒãƒ—é ˜åŸŸãƒ»è¦–èªæ€§è€ƒæ…®ã—ã¦å¤§ãã */
            height: 44px;
            border-radius: 14px;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .record-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .record-memo {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .record-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 2px;
        }

        .record-amount {
            font-size: 1rem;
            font-weight: 800;
            text-align: right;
            white-space: nowrap;
        }

        .record-amount.expense {
            color: var(--text-primary);
        }

        .record-amount.income {
            color: var(--income-green);
        }

        /* ===== ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ===== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-card);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.26, 1.55) infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* ===== ç©ºã®ã‚¹ãƒ†ãƒ¼ãƒˆ ===== */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state .empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.8;
        }

        .empty-state .empty-message {
            font-size: 0.9rem;
            line-height: 1.8;
            font-weight: 500;
        }

        /* ===== ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== Google Charts ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¸Šæ›¸ã ===== */
        .card text {
            fill: var(--text-secondary) !important;
        }

        /* ===== FABãƒœã‚¿ãƒ³ï¼ˆå…¥åŠ›ãƒœã‚¿ãƒ³ï¼‰ ===== */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 24px;
            width: 64px;
            /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ãå¤§ãã */
            height: 64px;
            border-radius: 32px;
            border: none;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: #fff;
            font-size: 2rem;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 8px 24px var(--accent-glow), 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
        }

        .fab:active {
            transform: scale(0.9);
        }

        .fab.open {
            transform: rotate(45deg);
            background: var(--danger);
            box-shadow: 0 8px 24px rgba(255, 126, 126, 0.3);
        }

        /* ===== ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 41, 59, 0.5);
            /* ãƒã‚¤ãƒ“ãƒ¼ç³»ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* ===== å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
        .input-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 1px solid var(--border-card);
            border-radius: 32px 32px 0 0;
            /* å¤§ãã‚ã«ã¨ã£ãŸè§’ä¸¸ */
            padding: 24px 24px 40px;
            z-index: 160;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.08);
        }

        .input-modal.active {
            transform: translateY(0);
        }

        .modal-handle {
            width: 48px;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            margin: 0 auto 24px;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-field {
            flex: 1;
            background: #F8FAFC;
            /* ã”ãè–„ã„ã‚°ãƒ¬ãƒ¼ */
            border: 2px solid transparent;
            /* åˆæœŸã¯ãƒœãƒ¼ãƒ€ãƒ¼ãƒ¬ã‚¹ã«ã¿ã›ã‚‹ */
            border-radius: 16px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .input-field:focus {
            background: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        .input-field::placeholder {
            color: var(--text-muted);
            font-weight: 500;
        }

        .input-field.amount {
            flex: 0 0 130px;
            font-weight: 800;
            font-size: 1.2rem;
        }

        /* ===== è¨­å®šãƒœã‚¿ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢UI ===== */
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .settings-btn,
        .refresh-btn {
            background: #ffffff;
            border: 1px solid var(--border-card);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        .settings-btn:active,
        .refresh-btn:active {
            transform: scale(0.9);
            box-shadow: none;
        }

        /* å›ºå®šè²»ãƒªã‚¹ãƒˆç”¨UI */
        .fixed-expense-row {
            display: flex;
            gap: 6px;
            align-items: center;
            background: #F8FAFC;
            padding: 8px;
            border-radius: 12px;
        }

        .fixed-expense-row select,
        .fixed-expense-row input {
            background: #fff;
            border: 1px solid var(--border-card);
            border-radius: 8px;
            padding: 8px 6px;
            font-size: 0.8rem;
            color: var(--text-primary);
            outline: none;
        }

        .fixed-expense-row select:focus,
        .fixed-expense-row input:focus {
            border-color: var(--accent-light);
        }

        .fixed-expense-row .del-btn {
            background: #fee2e2;
            color: var(--danger);
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
            font-weight: 800;
        }

        /* ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        textarea.input-styled {
            width: 100%;
            background: #F8FAFC;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 12px 16px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-primary);
            resize: vertical;
            min-height: 80px;
            outline: none;
            transition: all 0.3s;
        }

        textarea.input-styled:focus {
            background: #fff;
            border-color: var(--accent-light);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        /* ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒãƒƒãƒ— */
        .category-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 24px;
        }

        .chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            background: #F8FAFC;
            border: 1px solid var(--border-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .chip:active {
            transform: scale(0.92);
        }

        .chip.selected {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        /* é€ä¿¡ãƒœã‚¿ãƒ³ */
        .submit-btn {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: #fff;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 16px var(--accent-glow);
        }

        .submit-btn:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px var(--accent-glow);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ===== ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ===== */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: var(--bg-card);
            border: none;
            border-radius: 20px;
            padding: 12px 24px;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            z-index: 300;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background: #FEF2F2;
            color: var(--danger);
        }
    </style>
</head>

<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
        <div class="header-inner">
            <div>
                <h1>ğŸ  ã¿ãˆã‚‹åŒ–å®¶è¨ˆç°¿</h1>
                <div style="display: flex; align-items: center; gap: 12px; margin-top: 4px;">
                    <button class="nav-btn" onclick="changeMonth(-1)"
                        style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">â—€ï¸</button>
                    <div class="month-label" id="monthLabel" style="margin: 0;">èª­ã¿è¾¼ã¿ä¸­...</div>
                    <button class="nav-btn" onclick="changeMonth(1)"
                        style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">â–¶ï¸</button>
                </div>
            </div>
            <div class="header-actions">
                <button class="settings-btn" onclick="requestAiAnalysis()" title="AIã§åˆ†æã™ã‚‹"
                    style="font-size: 1.1rem; color: var(--accent);">ğŸ’¡</button>
                <button class="settings-btn" onclick="openSettingsModal()" title="è¨­å®š">âš™ï¸</button>
                <button class="refresh-btn" onclick="loadData(currentYear, currentMonth)" title="æ›´æ–°">ğŸ”„</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>

        <!-- æ”¯å‡ºã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
        <div class="card" id="summaryCard" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="card-title" style="margin-bottom: 0;"><span class="icon">ğŸ’°</span> ä»Šæœˆã®æ”¯å‡º</div>
                <div id="carryOverBadge"
                    style="font-size: 0.75rem; color: var(--text-secondary); background: rgba(0,0,0,0.03); padding: 4px 10px; border-radius: 12px; font-weight: 600;">
                    ğŸ ç¹°è¶Šèª­è¾¼ä¸­...
                </div>
            </div>
            <div class="summary-amount">
                <span class="currency">Â¥</span><span id="totalSpending">0</span>
            </div>
            <div class="summary-budget">äºˆç®— Â¥<span id="budgetAmount">0</span> ã®ã†ã¡ <strong id="percentUsed">0%</strong> ä½¿ç”¨
            </div>
            <div class="progress-bar">
                <div class="progress-fill safe" id="progressFill"></div>
            </div>
            <div class="progress-label">
                <span>Â¥0</span>
                <span>Â¥<span id="budgetLabel">0</span></span>
            </div>

            <div class="mini-cards">
                <div class="mini-card">
                    <div class="mini-label">ä»Šæœˆã®åå…¥</div>
                    <div class="mini-value green" id="totalIncome">Â¥0</div>
                </div>
                <div class="mini-card">
                    <div class="mini-label">æ®‹ã‚Šã®äºˆç®—</div>
                    <div class="mini-value accent" id="remainBudget">Â¥0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰ -->
    <div class="card" id="aiAdviceCard"
        style="display:none; background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px solid #e2e8f0;">
        <div class="card-title" style="color: #475569; margin-bottom: 8px;">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <span><span class="icon" style="background: #e2e8f0;">ğŸ¤–</span> å°‚å±ã‚¢ãƒŠãƒªã‚¹ãƒˆã®åˆ†æçµæœ</span>
                <span id="aiAnalysisLoading" style="display:none;font-size:0.8rem;color:#64748b;">åˆ†æä¸­...</span>
            </div>
        </div>
        <div id="aiMessageText"
            style="font-size: 0.9rem; line-height: 1.6; color: var(--text-primary); white-space: pre-wrap;"></div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º -->
    <div class="card" id="categoryCard" style="display:none;">
        <div class="card-title"><span class="icon">ğŸ¥§</span> ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡º</div>
        <div class="chart-container" id="pieChart"></div>
        <div class="category-legend" id="categoryLegend"></div>
    </div>

    <!-- ã‚µãƒ³ã‚­ãƒ¼ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ  -->
    <div class="card" id="sankeyCard" style="display:none;">
        <div class="card-title"><span class="icon">ğŸŒŠ</span> ãŠé‡‘ã®æµã‚Œ</div>
        <div class="sankey-container" id="sankeyChart"></div>
    </div>

    <!-- è³‡ç”£æ®‹é«˜ -->
    <div class="card" id="balanceCard" style="display:none;">
        <div class="card-title"><span class="icon">ğŸ¦</span> è³‡ç”£æ®‹é«˜</div>
        <div id="balanceList" style="display: flex; flex-direction: column; gap: 8px;"></div>
        <div id="totalBalance"
            style="text-align: right; margin-top: 16px; font-size: 1.15rem; font-weight: 800; color: var(--text-primary); border-top: 1px dashed var(--border-card); padding-top: 12px;">
            åˆè¨ˆ: Â¥0
        </div>
    </div>

    <!-- å¹´é–“åæ”¯ãƒ¬ãƒãƒ¼ãƒˆ -->
    <div class="card" id="yearlyReportCard" style="display:none;">
        <div class="card-title"><span class="icon">ğŸ“ˆ</span> å¹´é–“åæ”¯ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ<span id="yearlyChartYear"></span>å¹´ï¼‰</div>
        <div class="chart-container" id="yearlyChart" style="height: 240px; margin-top: 10px; width: 100%;"></div>
    </div>

    <!-- ç›´è¿‘ã®è¨˜éŒ² -->
    <div class="card" id="recordsCard" style="display:none;">
        <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
            <span><span class="icon">ğŸ“‹</span> æœ€è¿‘ã®è¨˜éŒ²</span>
            <button id="loadAllRecordsBtn" onclick="loadAllRecords()"
                style="font-size:0.75rem; padding:4px 10px; border-radius:20px; border:1px solid var(--accent-primary); color:var(--accent-primary); background:transparent; cursor:pointer;">å…¨ä»¶è¡¨ç¤º</button>
        </div>
        <ul class="record-list" id="recordList"></ul>
    </div>

    <!-- ç©ºã®ã‚¹ãƒ†ãƒ¼ãƒˆ -->
    <div class="card" id="emptyState" style="display:none;">
        <div class="empty-state">
            <div class="empty-icon">ğŸ“</div>
            <div class="empty-message">
                ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                LINEã‹ã‚‰ã€Œãƒ©ãƒ³ãƒ 1200ã€ã®ã‚ˆã†ã«<br>é€ä¿¡ã—ã¦è¨˜éŒ²ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼
            </div>
        </div>
    </div>
    </div>

    <!-- FABãƒœã‚¿ãƒ³ï¼ˆå…¥åŠ›ãƒœã‚¿ãƒ³ï¼‰ -->
    <button class="fab" id="fabBtn" onclick="toggleInputModal()">ï¼‹</button>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="modal-overlay" id="modalOverlay" onclick="toggleInputModal()"></div>

    <!-- å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="input-modal" id="inputModal">
        <div class="modal-handle"></div>
        <div class="modal-title" id="modalTitle">âœï¸ æ”¯å‡ºã‚’è¨˜éŒ²</div>

        <!-- å…¥åŠ›ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
        <div style="display:flex; gap:8px; margin-bottom:16px;" id="inputTypeTabs">
            <button class="chip selected" id="tab-expense" style="flex:1; font-size:0.85rem;"
                onclick="switchInputType('expense')">ğŸ’¸ æ”¯å‡º</button>
            <button class="chip" id="tab-income" style="flex:1; font-size:0.85rem;"
                onclick="switchInputType('income')">ğŸ’° åå…¥</button>
            <button class="chip" id="tab-transfer" style="flex:1; font-size:0.85rem;"
                onclick="switchInputType('transfer')">ğŸ¦ æŒ¯æ›¿ï¼ˆè²¯è“„ï¼‰</button>
        </div>

        <div class="input-row" style="margin-bottom: 12px;">
            <input type="date" class="input-field" id="inputDate" style="flex: 0 0 140px; color: var(--text-main);">
        </div>
        <div class="input-row">
            <input type="text" class="input-field" id="inputMemo" placeholder="å“åï¼ˆä¾‹ï¼šãƒ©ãƒ³ãƒï¼‰" autocomplete="off">
            <input type="number" class="input-field amount" id="inputAmount" placeholder="é‡‘é¡" inputmode="numeric">
        </div>

        <!-- æ”¯å‡ºã‚¿ãƒ–ç”¨: ã‚«ãƒ†ã‚´ãƒªã¨æ”¯æ‰•ã„å…ƒ -->
        <div id="expenseFields">
            <div class="category-chips" id="categoryChips">
                <button class="chip selected" data-cat="æœªåˆ†é¡" onclick="selectCategory(this)">ğŸ“¦ æœªåˆ†é¡</button>
                <button class="chip" data-cat="é£Ÿè²»" onclick="selectCategory(this)">ğŸ½ï¸ é£Ÿè²»</button>
                <button class="chip" data-cat="æ—¥ç”¨å“" onclick="selectCategory(this)">ğŸ§´ æ—¥ç”¨å“</button>
                <button class="chip" data-cat="äº¤é€šè²»" onclick="selectCategory(this)">ğŸšƒ äº¤é€šè²»</button>
                <button class="chip" data-cat="å¨¯æ¥½" onclick="selectCategory(this)">ğŸ® å¨¯æ¥½</button>
                <button class="chip" data-cat="åŒ»ç™‚" onclick="selectCategory(this)">ğŸ¥ åŒ»ç™‚</button>
                <button class="chip" data-cat="è¡£æœ" onclick="selectCategory(this)">ğŸ‘• è¡£æœ</button>
                <button class="chip" data-cat="é€šä¿¡è²»" onclick="selectCategory(this)">ğŸ“± é€šä¿¡è²»</button>
            </div>
            <div class="input-row" style="margin-top: 10px;" id="expenseAccountRow">
                <label style="font-size:0.8rem; color:var(--text-secondary); white-space:nowrap;">ğŸ¦ æ”¯æ‰•ã„å…ƒ</label>
                <select id="expenseAccount" class="input-field" style="flex:1; color:var(--text-primary);">
                    <option value="">-- å£åº§ã‚’é¸æŠ --</option>
                </select>
            </div>
        </div>

        <!-- åå…¥ã‚¿ãƒ–ç”¨: å…¥é‡‘å…ˆ -->
        <div id="incomeFields" style="display:none;">
            <div style="font-size:0.8rem; color:var(--text-muted); margin:8px 0 4px;">ä¾‹ï¼šçµ¦ä¸ãƒ»å‰¯æ¥­åå…¥ãƒ»é‚„ä»˜é‡‘ãªã©</div>
            <div class="input-row" style="margin-top: 6px;">
                <label style="font-size:0.8rem; color:var(--text-secondary); white-space:nowrap;">ğŸ¦ å…¥é‡‘å…ˆ</label>
                <select id="incomeAccount" class="input-field" style="flex:1; color:var(--text-primary);">
                    <option value="">-- å£åº§ã‚’é¸æŠ --</option>
                </select>
            </div>
        </div>

        <!-- æŒ¯æ›¿ï¼ˆè²¯è“„ï¼‰ã‚¿ãƒ–ç”¨ -->
        <div id="transferFields" style="display:none;">
            <div style="font-size:0.8rem; color:var(--text-muted); margin:8px 0 4px;">ä¾‹ï¼šNISAç©ç«‹ãƒ»éŠ€è¡ŒæŒ¯è¾¼ãƒ»ç¾é‡‘å¼•ãå‡ºã—ãªã©</div>
            <div class="input-row" style="margin-top: 6px;">
                <label style="font-size:0.8rem; color:var(--text-secondary); white-space:nowrap;">ğŸ¦ ç§»å‹•å…ƒ</label>
                <select id="transferFromAccount" class="input-field" style="flex:1; color:var(--text-primary);">
                    <option value="">-- å£åº§ã‚’é¸æŠ --</option>
                </select>
            </div>
        </div>

        <button class="submit-btn" id="submitBtn" onclick="submitExpense()">è¨˜éŒ²ã™ã‚‹ ğŸ“</button>
    </div>

    <!-- ===== è¨­å®šç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div class="modal-overlay" id="settingsOverlay" onclick="closeSettingsModal()"></div>
    <div class="input-modal" id="settingsModal">
        <div class="modal-handle"></div>
        <div class="modal-title">âš™ï¸ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®š</div>

        <div style="margin-bottom: 20px;">
            <label
                style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 700; margin-bottom: 6px; display: block;">æœˆé–“äºˆç®—
                (å††)</label>
            <div class="input-row" style="margin-bottom: 0;">
                <input type="number" id="settingBudget" class="input-field" placeholder="ä¾‹: 150000">
            </div>
        </div>

        <div style="margin-bottom: 24px;">
            <label
                style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 700; margin-bottom: 6px; display: block;">ã‚«ãƒ†ã‚´ãƒªä¸€è¦§
                (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
            <textarea id="settingCategories" class="input-styled" placeholder="é£Ÿè²», æ—¥ç”¨å“, äº¤é€šè²», å¨¯æ¥½..."></textarea>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; line-height: 1.4;">
                â€»ã“ã“ã§è¨­å®šã—ãŸã‚«ãƒ†ã‚´ãƒªãŒå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
                ï¼ˆéå»ã®ãƒ‡ãƒ¼ã‚¿å†…ã®ã‚«ãƒ†ã‚´ãƒªåã¯è‡ªå‹•å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ï¼‰
            </div>
        </div>

        <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 700;">ğŸ’³ å›ºå®šè²»ã®è‡ªå‹•è¨˜éŒ²</label>
                <button class="chip" style="padding: 4px 12px; font-size: 0.75rem; margin-bottom:0;"
                    onclick="addFixedExpenseRow()">ï¼‹ è¿½åŠ </button>
            </div>
            <div id="fixedExpensesList" style="display: flex; flex-direction: column; gap: 8px;"></div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">
                â€»æŒ‡å®šã—ãŸã€Œæ¯æœˆã€‡æ—¥ã€ã«è‡ªå‹•ã§å®¶è¨ˆç°¿ã¸è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚<br>
                ï¼ˆæœˆæœ«ãŒè¿‘ã„å ´åˆã¯å½“æœˆã®æœˆæœ«æ—¥ã§ã®è¨˜éŒ²ã‚‚è€ƒæ…®ã•ã‚Œã¾ã™ï¼‰
            </div>
        </div>

        <div style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="font-size: 0.85rem; color: var(--text-secondary); font-weight: 700;">ğŸ¦ å£åº§ï¼ˆè³‡ç”£ï¼‰ã®ç®¡ç†</label>
                <button class="chip" style="padding: 4px 12px; font-size: 0.75rem; margin-bottom:0;"
                    onclick="addAccountRow()">ï¼‹ è¿½åŠ </button>
            </div>
            <div id="accountsList" style="display: flex; flex-direction: column; gap: 8px;"></div>
            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px; line-height: 1.4;">
                â€»ã“ã“ã§ç™»éŒ²ã—ãŸå£åº§åãŒå…¥åŠ›ç”»é¢ã®ã€Œæ”¯æ‰•ã„å…ƒã€ã¨ã—ã¦é¸ã¹ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br>
                â€»ã€Œç¾åœ¨ã®æ®‹é«˜ã€ã¯ã“ã‚Œã¾ã§ã®å…¨æœŸé–“ã®åæ”¯çµæœã«ãƒã‚¤ãƒŠã‚¹ã¾ãŸã¯ãƒ—ãƒ©ã‚¹ã•ã‚Œã‚‹åŸºæº–å€¤ã§ã™ã€‚
            </div>
        </div>

        <div style="display: flex; gap: 12px;">
            <button class="submit-btn"
                style="flex: 1; background: #E2E8F0; color: var(--text-primary); box-shadow: none;"
                onclick="closeSettingsModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="submit-btn" style="flex: 2;" id="saveSettingsBtn" onclick="saveSettings()">ä¿å­˜ã—ã¦åæ˜  âœ¨</button>
        </div>
    </div>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div class="toast" id="toast"></div>

    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <script>
        // ãƒãƒ£ãƒ¼ãƒˆç”¨ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ (Kawaii & Clean ãƒ‘ã‚¹ãƒ†ãƒ«)
        const COLORS = ['#FF9CEE', '#B28DFF', '#6EB5FF', '#85E3FF', '#AFF8D8', '#E7FFAC', '#FFF5BA', '#FFABAB'];

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¢ã‚¤ã‚³ãƒ³ãƒãƒƒãƒ—
        const CATEGORY_ICONS = {
            'é£Ÿè²»': 'ğŸ½ï¸', 'æ—¥ç”¨å“': 'ğŸ§´', 'äº¤é€šè²»': 'ğŸšƒ', 'å›ºå®šè²»': 'ğŸ ',
            'å¨¯æ¥½': 'ğŸ®', 'åŒ»ç™‚': 'ğŸ¥', 'è¡£æœ': 'ğŸ‘•', 'æ•™è‚²': 'ğŸ“š',
            'é€šä¿¡è²»': 'ğŸ“±', 'çµ¦ä¸': 'ğŸ’¼', 'åå…¥': 'ğŸ’°', 'æœªåˆ†é¡': 'ğŸ“¦'
        };

        // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹å¹´æœˆã¨è¨­å®šæƒ…å ±ã‚’ç®¡ç†
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0-11
        let currentSettings = { budget: 150000, categories: "é£Ÿè²»,æ—¥ç”¨å“,äº¤é€šè²»,å¨¯æ¥½,åŒ»ç™‚,è¡£æœ,é€šä¿¡è²»", fixedExpenses: [], accounts: [{ name: 'è²¡å¸ƒ(ç¾é‡‘)', balance: 0 }] };

        // GAS Web App API URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è¨­å®šï¼‰
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwGaTOpyyWYdmXoeZpVPBCyQcjQTNGFvmbQw4STx_-KPpBoGEzTbUjzUY7lZQjT2bQU/exec';

        /**
         * GAS API å…±é€šå‘¼ã³å‡ºã—ãƒ©ãƒƒãƒ‘ãƒ¼
         * @param {string} action - APIå
         * @param {object} params - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
         * @param {string} method - 'GET' or 'POST'ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: GETï¼‰
         * @returns {Promise<any>}
         */
        function callGAS(action, params, method) {
            method = method || 'GET';

            if (method === 'GET') {
                var query = 'action=' + encodeURIComponent(action);
                if (params) {
                    Object.keys(params).forEach(function (key) {
                        if (params[key] !== undefined && params[key] !== null) {
                            query += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
                        }
                    });
                }
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ï¼ˆå¸¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ï¼‰
                query += '&_=' + new Date().getTime();

                return fetch(GAS_API_URL + '?' + query)
                    .then(function (res) { return res.json(); });
            } else {
                var body = Object.assign({ action: action }, params || {});
                return fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(body)
                }).then(function (res) { return res.json(); });
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨­å®šæƒ…å ±ã‚‚å–å¾—
        if (GAS_API_URL) {
            callGAS('getSettingsData').then(function (res) {
                if (res && res.budget) {
                    currentSettings = res;
                    if (!currentSettings.accounts) currentSettings.accounts = [];
                    if (!currentSettings.fixedExpenses) currentSettings.fixedExpenses = [];
                }
            }).catch(function () { });
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼‰
         */
        function loadData(year, month) {
            document.getElementById('loadingState').style.display = 'flex';
            hideAllCards();

            // å¼•æ•°ãŒçœç•¥ã•ã‚ŒãŸå ´åˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
            const targetYear = year !== undefined ? year : currentYear;
            const targetMonth = month !== undefined ? month : currentMonth;

            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰:', targetYear, 'å¹´', targetMonth + 1, 'æœˆ');
                setTimeout(function () {
                    // æœˆã«ã‚ˆã£ã¦ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    let mockData, mockSankey;

                    if (targetMonth === new Date().getMonth()) {
                        // ä»Šæœˆã®ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
                        mockData = {
                            monthLabel: targetYear + "å¹´" + (targetMonth + 1) + "æœˆ",
                            budget: 150000,
                            totalSpending: 95000,
                            totalIncome: 300000,
                            carryOver: 20000, // ä»¥å‰ã®æœˆã‹ã‚‰ã®ç¹°è¶Šã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                            categories: [
                                { name: "é£Ÿè²»", amount: 45000 },
                                { name: "æ—¥ç”¨å“", amount: 12000 },
                                { name: "äº¤é€šè²»", amount: 8000 },
                                { name: "å¨¯æ¥½", amount: 20000 },
                                { name: "é€šä¿¡è²»", amount: 10000 }
                            ],
                            recentRecords: [
                                { date: (targetMonth + 1) + "/05", category: "é£Ÿè²»", memo: "ã‚¹ãƒ¼ãƒ‘ãƒ¼", method: "ã‚«ãƒ¼ãƒ‰", amount: 5600, type: "æ”¯å‡º" },
                                { date: (targetMonth + 1) + "/04", category: "äº¤é€šè²»", memo: "ãƒãƒ£ãƒ¼ã‚¸", method: "ç¾é‡‘", amount: 3000, type: "æ”¯å‡º" },
                                { date: (targetMonth + 1) + "/02", category: "æ—¥ç”¨å“", memo: "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢", method: "PayPay", amount: 2800, type: "æ”¯å‡º" }
                            ],
                            accountBalances: { "è²¡å¸ƒ(ç¾é‡‘)": 52600, "BankA": -15000 },
                            aiMessage: "ğŸ¤– ã€AIå®¶è¨ˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘\n\nä»Šæœˆã¯é£Ÿè²»ãŒã‚ˆãæŠ‘ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã­ï¼ç´ æ™´ã‚‰ã—ã„ã§ã™âœ¨\nã“ã®èª¿å­ã§äº¤éš›è²»ã‚’ã‚ã¨å°‘ã—æŠ‘ãˆã‚‰ã‚Œã‚Œã°ã€æ¥æœˆã¯ã•ã‚‰ã«è²¯é‡‘é¡ãŒã‚¢ãƒƒãƒ—ã—ãã†ã§ã™ğŸ’¡\n\nâ€»ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯AIãŒä½œæˆã—ã¾ã—ãŸâœ¨"
                        };
                        mockSankey = {
                            flows: [
                                ["çµ¦ä¸", "ç”Ÿæ´»è²»", 100000],
                                ["çµ¦ä¸", "è²¯é‡‘", 50000],
                                ["ç”Ÿæ´»è²»", "é£Ÿè²»", 40000],
                                ["ç”Ÿæ´»è²»", "æ—¥ç”¨å“", 20000],
                                ["ç”Ÿæ´»è²»", "ãã®ä»–", 40000]
                            ]
                        };
                    } else {
                        // éå»ã®ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
                        mockData = {
                            monthLabel: targetYear + "å¹´" + (targetMonth + 1) + "æœˆ",
                            budget: 150000,
                            totalSpending: 148000,
                            totalIncome: 280000,
                            carryOver: -5000, // ãƒã‚¤ãƒŠã‚¹ã®ç¹°è¶Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                            categories: [
                                { name: "é£Ÿè²»", amount: 60000 },
                                { name: "å¨¯æ¥½", amount: 38000 },
                                { name: "å›ºå®šè²»", amount: 50000 }
                            ],
                            recentRecords: [
                                { date: (targetMonth + 1) + "/20", category: "å¨¯æ¥½", memo: "æ˜ ç”»", method: "ã‚«ãƒ¼ãƒ‰", amount: 3800, type: "æ”¯å‡º" }
                            ],
                            aiMessage: "ğŸ¤– ã€AIå®¶è¨ˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘\n\nå¨¯æ¥½è²»ãŒå°‘ã—äºˆç®—ã‚’ã‚ªãƒ¼ãƒãƒ¼æ°—å‘³ã®ã‚ˆã†ã§ã™ã­ğŸ‘€\næ¥é€±ã¯ã€ŒãŠã†ã¡ã§ã‚†ã£ãã‚Šéã”ã™æ—¥ã€ã‚’ä½œã£ã¦ã¿ã‚‹ã®ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ\n\nâ€»ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯AIãŒä½œæˆã—ã¾ã—ãŸâœ¨"
                        };
                        mockSankey = {
                            flows: [
                                ["çµ¦ä¸", "ç”Ÿæ´»è²»", 150000],
                                ["çµ¦ä¸", "è²¯é‡‘", 30000],
                                ["ç”Ÿæ´»è²»", "é£Ÿè²»", 60000],
                                ["ç”Ÿæ´»è²»", "å¨¯æ¥½", 40000],
                                ["ç”Ÿæ´»è²»", "å›ºå®šè²»", 50000]
                            ]
                        };
                    }

                    onDashboardDataLoaded(mockData);
                    try {
                        renderSankey(mockSankey);
                    } catch (e) {
                        console.error('Sankeyæç”»ã‚¨ãƒ©ãƒ¼:', e);
                    }
                    try {
                        let mockYearlyData = { year: targetYear, monthlyData: [] };
                        let cuml = 100000;
                        for (let m = 1; m <= 12; m++) {
                            let inc = m <= targetMonth + 1 ? 300000 : 0;
                            let exp = m <= targetMonth + 1 ? 250000 + Math.random() * 50000 : 0;
                            let sav = inc - exp;
                            if (m <= targetMonth + 1) cuml += sav;
                            mockYearlyData.monthlyData.push({ month: m, income: inc, expense: exp, savings: sav, cumulativeSavings: cuml });
                        }
                        renderYearlyChart(mockYearlyData);
                    } catch (e) {
                        console.error('Yearly Chartæç”»ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }, 800);
                return;
            }

            // GASã®ã‚µãƒ¼ãƒãƒ¼é–¢æ•°ã‚’å‘¼ã³å‡ºã—
            callGAS('getDashboardData', { year: targetYear, month: targetMonth })
                .then(onDashboardDataLoaded)
                .catch(onError);
        }

        /**
         * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å—ä¿¡å¾Œã®å‡¦ç†
         */
        function onDashboardDataLoaded(data) {
            document.getElementById('loadingState').style.display = 'none';

            if (data.error) {
                showError(data.error);
                return;
            }

            // æœˆè¡¨ç¤º
            document.getElementById('monthLabel').textContent = data.monthLabel;

            // ãƒ‡ãƒ¼ã‚¿ãŒã‚¼ãƒ­ã®å ´åˆ
            if (data.totalSpending === 0 && data.totalIncome === 0 && data.recentRecords.length === 0) {
                showCard('emptyState');
                return;
            }

            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
            renderSummary(data);

            // AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚«ãƒ¼ãƒ‰
            if (data.aiMessage) {
                // LINEç”¨ã®è£…é£¾ãƒ˜ãƒƒãƒ€ãƒ¼/ãƒ•ãƒƒã‚¿ãƒ¼ã‚’ç”»é¢ç”¨ã«å°‘ã—ã‚¯ãƒªãƒ¼ãƒ³ãƒŠãƒƒãƒ—
                var cleanMsg = data.aiMessage
                    .replace(/ğŸ¤– ã€AIå®¶è¨ˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‘\n\n/, '')
                    .replace(/\n\nâ€»ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯AIãŒä½œæˆã—ã¾ã—ãŸâœ¨/, '');
                document.getElementById('aiMessageText').textContent = cleanMsg;
                showCard('aiAdviceCard');
            } else {
                document.getElementById('aiAdviceCard').style.display = 'none';
            }

            // ã‚«ãƒ†ã‚´ãƒªåˆ¥å††ã‚°ãƒ©ãƒ•
            if (data.categories.length > 0) {
                renderPieChart(data.categories);
            }

            // å–å¼•å±¥æ­´
            if (data.recentRecords.length > 0) {
                renderRecords(data.recentRecords);
            }

            // è³‡ç”£æ®‹é«˜ãƒªã‚¹ãƒˆã®æç”»
            const balList = document.getElementById('balanceList');
            balList.innerHTML = '';
            let totalBal = 0;
            let hasBalance = false;

            if (data.accountBalances && Object.keys(data.accountBalances).length > 0) {
                for (let accName in data.accountBalances) {
                    hasBalance = true;
                    let balance = data.accountBalances[accName];
                    totalBal += balance;

                    let color = balance < 0 ? 'var(--danger)' : 'var(--text-primary)';
                    let rowHtml = `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;">
                            <span style="font-size:0.95rem; font-weight:700; color:var(--text-secondary);">${escapeHtml(accName)}</span>
                            <span style="font-weight:700; font-size:1.1rem; color:${color};">Â¥${balance.toLocaleString()}</span>
                        </div>
                    `;
                    balList.insertAdjacentHTML('beforeend', rowHtml);
                }
            }

            if (hasBalance) {
                let sumColor = totalBal < 0 ? 'var(--danger)' : 'var(--accent)';
                document.getElementById('totalBalance').innerHTML = 'åˆè¨ˆ: <span style="color:' + sumColor + '">Â¥' + totalBal.toLocaleString() + '</span>';
                showCard('balanceCard');
            } else {
                document.getElementById('balanceCard').style.display = 'none';
            }

            // ã‚µãƒ³ã‚­ãƒ¼ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ï¼ˆåˆ¥APIã§å–å¾—ï¼‰
            if (GAS_API_URL) {
                callGAS('getSankeyData', { year: currentYear, month: currentMonth })
                    .then(renderSankey)
                    .catch(function () { /* ã‚µãƒ³ã‚­ãƒ¼ãŒå¤±æ•—ã—ã¦ã‚‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯è¡¨ç¤º */ });

                // å¹´é–“ãƒ¬ãƒãƒ¼ãƒˆï¼ˆåˆ¥APIã§å–å¾—ï¼‰
                callGAS('getYearlyReportData', { year: currentYear })
                    .then(renderYearlyChart)
                    .catch(function () { /* å¹´é–“ãƒ¬ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ */ });
            }
        }

        /**
         * æ”¯å‡ºã‚µãƒãƒªãƒ¼ã®æç”»
         */
        function renderSummary(data) {
            var budget = data.budget;
            var spent = data.totalSpending;
            var percent = budget > 0 ? Math.round((spent / budget) * 100) : 0;
            var remain = budget - spent;

            // ç¹°è¶Šé‡‘è¡¨ç¤ºã®æ›´æ–°
            var carryOverBadge = document.getElementById('carryOverBadge');
            if (carryOverBadge && data.carryOver !== undefined) {
                var carryAmount = data.carryOver;
                var carryStr = carryAmount >= 0 ? "+Â¥" + carryAmount.toLocaleString() : "-Â¥" + Math.abs(carryAmount).toLocaleString();
                var badgeStyle = carryAmount >= 0 ? "background:#E8F5E9; color:#2E7D32;" : "background:#FFEBEE; color:#D32F2F;";
                carryOverBadge.innerHTML = 'ğŸ å‰æœˆç¹°è¶Š: ' + carryStr;
                carryOverBadge.setAttribute('style', 'font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; font-weight: 600; ' + badgeStyle);
            }

            // æ•°å€¤ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            animateNumber('totalSpending', spent);
            document.getElementById('budgetAmount').textContent = budget.toLocaleString();
            document.getElementById('budgetLabel').textContent = budget.toLocaleString();
            document.getElementById('percentUsed').textContent = percent + '%';
            document.getElementById('totalIncome').textContent = 'Â¥' + data.totalIncome.toLocaleString();

            // æ®‹ã‚Šã®äºˆç®—ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            var remainEl = document.getElementById('remainBudget');
            var statusClass = 'safe';
            var remainIcon = 'âœ¨ ';

            if (percent > 85) {
                statusClass = 'danger';
                remainIcon = 'âš ï¸ ';
            } else if (percent > 60) {
                statusClass = 'warning';
                remainIcon = 'ğŸ‘€ ';
            }

            remainEl.className = 'mini-value ' + statusClass;
            // ãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯èµ¤å­—å¼·èª¿
            if (remain < 0) {
                statusClass = 'danger';
                remainEl.className = 'mini-value danger';
                remainIcon = 'ğŸš¨ ';
            }
            remainEl.textContent = remainIcon + 'Â¥' + remain.toLocaleString();

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
            var fill = document.getElementById('progressFill');
            fill.className = 'progress-fill ' + statusClass;
            setTimeout(function () {
                fill.style.width = Math.min(percent, 100) + '%';
            }, 100);

            showCard('summaryCard');
        }

        /**
         * ã‚«ãƒ†ã‚´ãƒªåˆ¥å††ã‚°ãƒ©ãƒ•ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•ï¼‰ã®æç”» - D3.jsç‰ˆ
         */
        function renderPieChart(categories) {
            var container = document.getElementById('pieChart');
            container.innerHTML = ''; // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢

            if (!categories || categories.length === 0) return;

            // ã‚µã‚¤ã‚ºè¨­å®š
            var width = container.clientWidth || 300;
            var height = container.clientHeight || 240;
            var radius = Math.min(width, height) / 2 - 10;
            var innerRadius = radius * 0.55; // ãƒ‰ãƒ¼ãƒŠãƒ„ã®å¤ªã•

            var svg = d3.select('#pieChart')
                .append('svg')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('viewBox', '0 0 ' + width + ' ' + height)
                .style('overflow', 'visible');

            var g = svg.append('g')
                .attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');

            var color = d3.scaleOrdinal()
                .domain(categories.map(function (d) { return d.name; }))
                .range(COLORS);

            var pie = d3.pie()
                .value(function (d) { return d.amount; })
                .sort(null)
                .padAngle(0.03);

            var arc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(radius)
                .cornerRadius(10); // è§’ã‚’ä¸¸ã

            var total = d3.sum(categories, function (d) { return d.amount; });

            // ä¸­å¤®ã®ãƒ†ã‚­ã‚¹ãƒˆ
            g.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '-0.3em')
                .text('Total')
                .style('font-size', '0.85rem')
                .style('font-weight', '700')
                .style('fill', 'var(--text-secondary)');

            g.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '1.1em')
                .text('Â¥' + total.toLocaleString())
                .style('font-size', '1.4rem')
                .style('font-weight', '800')
                .style('fill', 'var(--text-primary)');

            // ã‚¹ãƒ©ã‚¤ã‚¹ã®æç”»ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            var paths = g.selectAll('path')
                .data(pie(categories))
                .join('path')
                .attr('fill', function (d) { return color(d.data.name); })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2);

            // ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            paths.transition()
                .duration(1200)
                .ease(d3.easeCubicOut)
                .attrTween('d', function (d) {
                    var i = d3.interpolate({ startAngle: 0, endAngle: 0 }, d);
                    return function (t) { return arc(i(t)); };
                });

            // ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            paths.on('mouseover', function (event, d) {
                d3.select(this)
                    .transition().duration(200)
                    .attr('transform', 'scale(1.05)');
            }).on('mouseout', function (event, d) {
                d3.select(this)
                    .transition().duration(200)
                    .attr('transform', 'scale(1)');
            });

            // ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰
            var legendEl = document.getElementById('categoryLegend');
            legendEl.innerHTML = '';
            categories.forEach(function (cat, i) {
                var pct = total > 0 ? Math.round((cat.amount / total) * 100) : 0;
                var item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = '<span class="legend-dot" style="background:' + COLORS[i % COLORS.length] + '"></span>' +
                    cat.name + ' <span class="legend-amount">Â¥' + cat.amount.toLocaleString() + '</span> (' + pct + '%)';
                legendEl.appendChild(item);
            });

            showCard('categoryCard');
        }

        /**
         * ã‚µãƒ³ã‚­ãƒ¼ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã®æç”» - D3.jsç‰ˆ
         */
        function renderSankey(sankeyData) {
            if (!sankeyData || !sankeyData.flows || sankeyData.flows.length === 0) return;

            // DOMã‚µã‚¤ã‚ºã‚’æ­£ã—ãå–å¾—ã™ã‚‹ãŸã‚ã€å…ˆã«è¡¨ç¤ºã‚’ONã«ã™ã‚‹
            showCard('sankeyCard');

            // è¡¨ç¤ºãŒDOMã«åæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰æç”»ã™ã‚‹
            requestAnimationFrame(function () {
                var container = document.getElementById('sankeyChart');
                container.innerHTML = ''; // ã‚¯ãƒªã‚¢

                var width = container.clientWidth || 300;
                var height = container.clientHeight || 240;

                var svg = d3.select('#sankeyChart')
                    .append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .attr('viewBox', '0 0 ' + width + ' ' + height)
                    .style('overflow', 'visible');

                // GASã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿: ['From', 'To', Amount]
                // d3-sankeyç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ `{nodes: [], links: []}` ã¸ã®å¤‰æ›
                var nodesMap = new Map();
                sankeyData.flows.forEach(function (f) {
                    nodesMap.set(f[0], { name: f[0] });
                    nodesMap.set(f[1], { name: f[1] });
                });
                var nodes = Array.from(nodesMap.values());

                var links = sankeyData.flows.map(function (f) {
                    return {
                        source: nodes.findIndex(n => n.name === f[0]),
                        target: nodes.findIndex(n => n.name === f[1]),
                        value: f[2]
                    };
                });

                var sankey = d3.sankey()
                    .nodeWidth(16)
                    .nodePadding(20)
                    .extent([[10, 10], [width - 10, height - 10]]);

                var graph = sankey({
                    nodes: nodes.map(d => Object.assign({}, d)),
                    links: links.map(d => Object.assign({}, d))
                });

                var color = d3.scaleOrdinal()
                    .domain(nodes.map(d => d.name))
                    .range(COLORS);

                // ãƒªãƒ³ã‚¯ï¼ˆç·šï¼‰ã®æç”»
                var link = svg.append('g')
                    .attr('fill', 'none')
                    .attr('stroke-opacity', 0.2)
                    .selectAll('g')
                    .data(graph.links)
                    .join('g')
                    .style('mix-blend-mode', 'multiply');

                // ãƒªãƒ³ã‚¯ãƒ‘ã‚¹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                var paths = link.append('path')
                    .attr('d', d3.sankeyLinkHorizontal())
                    .attr('stroke', function (d) {
                        return color(d.source.name);
                    })
                    .attr('stroke-width', 0) // æœ€åˆã¯0
                    .transition()
                    .duration(1200)
                    .ease(d3.easeCubicOut)
                    .attr('stroke-width', function (d) { return Math.max(1, d.width); });

                // ãƒãƒ¼ãƒ‰ï¼ˆå››è§’ï¼‰ã®æç”»
                var nodeGroup = svg.append('g')
                    .selectAll('g')
                    .data(graph.nodes)
                    .join('g');

                nodeGroup.append('rect')
                    .attr('x', function (d) { return d.x0; })
                    .attr('y', function (d) { return d.y0; })
                    .attr('height', function (d) { return Math.max(0, d.y1 - d.y0); })
                    .attr('width', function (d) { return d.x1 - d.x0; })
                    .attr('fill', function (d) { return color(d.name); })
                    .attr('rx', 4) // è§’ä¸¸
                    .attr('ry', 4)
                    .attr('opacity', 0) // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
                    .transition()
                    .duration(800)
                    .delay(400)
                    .attr('opacity', 0.9);

                // ãƒ©ãƒ™ãƒ«ã®æç”»
                nodeGroup.append('text')
                    .attr('x', function (d) { return d.x0 < width / 2 ? d.x1 + 8 : d.x0 - 8; })
                    .attr('y', function (d) { return (d.y1 + d.y0) / 2; })
                    .attr('dy', '0.35em')
                    .attr('text-anchor', function (d) { return d.x0 < width / 2 ? 'start' : 'end'; })
                    .text(function (d) { return d.name; })
                    .style('font-size', '0.75rem')
                    .style('font-weight', '700')
                    .style('fill', 'var(--text-secondary)')
                    .attr('opacity', 0)
                    .transition()
                    .duration(800)
                    .delay(800)
                    .attr('opacity', 1);
            });
        }

        /**
         * å¹´é–“åæ”¯ãƒ¬ãƒãƒ¼ãƒˆã®æç”» - D3.jsç‰ˆ
         */
        function renderYearlyChart(yearlyData) {
            if (!yearlyData || !yearlyData.monthlyData || yearlyData.monthlyData.length === 0) return;

            document.getElementById('yearlyChartYear').textContent = yearlyData.year;
            showCard('yearlyReportCard');

            requestAnimationFrame(function () {
                var container = document.getElementById('yearlyChart');
                container.innerHTML = '';

                var width = container.clientWidth || 300;
                var height = container.clientHeight || 240;
                var margin = { top: 20, right: 40, bottom: 30, left: 40 };

                var innerWidth = width - margin.left - margin.right;
                var innerHeight = height - margin.top - margin.bottom;

                var svg = d3.select('#yearlyChart')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .append('g')
                    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

                var data = yearlyData.monthlyData;

                // X Scale (Months)
                var x = d3.scaleBand()
                    .domain(data.map(function (d) { return d.month + 'æœˆ'; }))
                    .range([0, innerWidth])
                    .padding(0.3);

                // Y Scale Left (Expenses)
                var yLeft = d3.scaleLinear()
                    .domain([0, d3.max(data, function (d) { return Math.max(d.expense, d.income) * 1.1; }) || 100000])
                    .range([innerHeight, 0]);

                // Y Scale Right (Cumulative Savings)
                var yRight = d3.scaleLinear()
                    .domain([
                        Math.min(0, d3.min(data, function (d) { return d.cumulativeSavings; }) * 1.1),
                        Math.max(0, d3.max(data, function (d) { return d.cumulativeSavings; }) * 1.1) || 100000
                    ])
                    .range([innerHeight, 0]);

                // Axes
                svg.append('g')
                    .attr('transform', 'translate(0,' + innerHeight + ')')
                    .call(d3.axisBottom(x).tickSizeOuter(0))
                    .selectAll("text")
                    .style("fill", "var(--text-secondary)")
                    .style("font-family", "'Nunito', 'M PLUS Rounded 1c', sans-serif");

                // Left Axis
                svg.append('g')
                    .call(d3.axisLeft(yLeft).ticks(5).tickFormat(function (d) { return d / 1000 + 'k'; }))
                    .selectAll("text").style("fill", "var(--text-secondary)");

                // Right Axis
                svg.append('g')
                    .attr('transform', 'translate(' + innerWidth + ',0)')
                    .call(d3.axisRight(yRight).ticks(5).tickFormat(function (d) { return d / 1000 + 'k'; }))
                    .selectAll("text").style("fill", "#6EB5FF");

                // Bar Chart (Expenses)
                var bars = svg.selectAll('.bar')
                    .data(data)
                    .enter().append('rect')
                    .attr('class', 'bar')
                    .attr('x', function (d) { return x(d.month + 'æœˆ'); })
                    .attr('width', x.bandwidth())
                    .attr('y', innerHeight)
                    .attr('height', 0)
                    .attr('fill', '#FF9CEE')
                    .attr('rx', 3)
                    .attr('ry', 3);

                bars.transition()
                    .duration(800)
                    .delay(function (d, i) { return i * 50; })
                    .attr('y', function (d) { return yLeft(d.expense); })
                    .attr('height', function (d) { return innerHeight - yLeft(d.expense); });

                // Line Chart (Cumulative Savings)
                var line = d3.line()
                    .x(function (d) { return x(d.month + 'æœˆ') + x.bandwidth() / 2; })
                    .y(function (d) { return yRight(d.cumulativeSavings); })
                    .curve(d3.curveMonotoneX);

                var path = svg.append('path')
                    .datum(data)
                    .attr('fill', 'none')
                    .attr('stroke', '#6EB5FF')
                    .attr('stroke-width', 3)
                    .attr('d', line);

                var totalLength = path.node().getTotalLength();

                path.attr("stroke-dasharray", totalLength + " " + totalLength)
                    .attr("stroke-dashoffset", totalLength)
                    .transition()
                    .duration(1500)
                    .ease(d3.easeLinear)
                    .attr("stroke-dashoffset", 0);

                // Dots for Line Chart
                var dots = svg.selectAll('.dot')
                    .data(data)
                    .enter().append('circle')
                    .attr('class', 'dot')
                    .attr('cx', function (d) { return x(d.month + 'æœˆ') + x.bandwidth() / 2; })
                    .attr('cy', function (d) { return yRight(d.cumulativeSavings); })
                    .attr('r', 0)
                    .attr('fill', '#fff')
                    .attr('stroke', '#6EB5FF')
                    .attr('stroke-width', 2);

                dots.transition()
                    .duration(500)
                    .delay(function (d, i) { return 1500 + i * 50; })
                    .attr('r', 4);
            });
        }

        /**
         * å–å¼•å±¥æ­´ã®æç”»
         */
        function renderRecords(records) {
            var listEl = document.getElementById('recordList');
            listEl.innerHTML = '';

            records.forEach(function (rec) {
                var icon = CATEGORY_ICONS[rec.category] || 'ğŸ“¦';
                var colorIdx = Object.keys(CATEGORY_ICONS).indexOf(rec.category);
                var bgColor = COLORS[colorIdx >= 0 ? colorIdx % COLORS.length : 0];
                var rowIndex = rec.rowIndex || 0;

                var li = document.createElement('li');
                li.className = 'record-item';
                li.style.cursor = 'pointer';
                li.setAttribute('data-row', rowIndex);

                // è¡¨ç¤ºè¡Œ
                var displayDiv = document.createElement('div');
                displayDiv.style.cssText = 'display:flex; align-items:center; width:100%; gap:10px;';
                displayDiv.innerHTML =
                    '<div class="record-icon" style="background: ' + bgColor + '22">' + icon + '</div>' +
                    '<div class="record-info" style="flex:1; min-width:0;">' +
                    '  <div class="record-memo">' + escapeHtml(rec.memo) + '</div>' +
                    '  <div class="record-meta">' + rec.date + ' Â· ' + rec.category + ' Â· ' + (rec.method || '') + '</div>' +
                    '</div>' +
                    '<div class="record-amount ' + (rec.type === 'åå…¥' ? 'income' : 'expense') + '" style="white-space:nowrap;">' +
                    (rec.type === 'åå…¥' ? '+' : '-') + 'Â¥' + rec.amount.toLocaleString() +
                    '</div>' +
                    '<div style="font-size:0.7rem; color:var(--text-muted); margin-left:4px;">âœï¸</div>';

                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰
                var editDiv = document.createElement('div');
                editDiv.className = 'record-edit-form';
                editDiv.style.cssText = 'display:none; width:100%; padding:10px 0 4px;';

                // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ï¼ˆæœªåˆ†é¡ã‚’å¿…ãšå«ã‚€ï¼‰
                var catOptions = (currentSettings.categories || 'æœªåˆ†é¡,é£Ÿè²»,æ—¥ç”¨å“,äº¤é€šè²»,å¨¯æ¥½,åŒ»ç™‚,è¡£æœ,é€šä¿¡è²»').split(',').map(function (c) { return c.trim(); });
                if (catOptions.indexOf('æœªåˆ†é¡') < 0) catOptions.unshift('æœªåˆ†é¡');
                if (catOptions.indexOf('è¿”é‡‘') < 0) catOptions.push('è¿”é‡‘');

                // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã‚’ç”Ÿæˆ
                var chipsHtml = '<div style="margin-bottom:6px; font-size:0.7rem; color:var(--text-muted);">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠï¼ˆã‚¿ãƒƒãƒ—ã§å³ä¿å­˜ï¼‰</div>';
                chipsHtml += '<div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">';
                catOptions.forEach(function (cat) {
                    var isActive = cat === rec.category;
                    var chipIcon = CATEGORY_ICONS[cat] || 'ğŸ“¦';
                    chipsHtml += '<button class="cat-chip" data-cat="' + escapeHtml(cat) + '" style="' +
                        'font-size:0.75rem; padding:5px 10px; border-radius:16px; cursor:pointer; ' +
                        'border:' + (isActive ? '2px solid var(--accent-primary)' : '1px solid var(--border-card)') + '; ' +
                        'background:' + (isActive ? 'var(--accent-primary)' : 'transparent') + '; ' +
                        'color:' + (isActive ? '#fff' : 'var(--text-primary)') + '; ' +
                        'font-weight:' + (isActive ? '700' : '400') + ';">' +
                        chipIcon + ' ' + escapeHtml(cat) + '</button>';
                });
                chipsHtml += '</div>';

                // ãƒ¡ãƒ¢ç·¨é›†è¡Œ
                chipsHtml += '<div style="display:flex; gap:6px; align-items:center;">' +
                    '<label style="font-size:0.7rem; color:var(--text-muted); white-space:nowrap;">âœï¸ å“å:</label>' +
                    '<input type="text" class="edit-memo-input input-field" value="' + escapeHtml(rec.memo) + '" style="flex:1; font-size:0.8rem; padding:6px 8px;">' +
                    '<button class="edit-memo-save" style="font-size:0.7rem; padding:5px 10px; border-radius:16px; border:none; background:var(--accent-primary); color:#fff; cursor:pointer;">å¤‰æ›´</button>' +
                    '</div>';

                editDiv.innerHTML = chipsHtml;

                li.appendChild(displayDiv);
                li.appendChild(editDiv);

                // ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒˆã‚°ãƒ«
                displayDiv.addEventListener('click', function () {
                    var wasVisible = editDiv.style.display !== 'none';
                    // ä»–ã®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’å…¨ã¦é–‰ã˜ã‚‹
                    document.querySelectorAll('.record-edit-form').forEach(function (f) { f.style.display = 'none'; });
                    if (!wasVisible) editDiv.style.display = 'block';
                });

                // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã®ã‚¯ãƒªãƒƒã‚¯ â†’ å³ä¿å­˜
                (function (ri, ed, recObj) {
                    ed.querySelectorAll('.cat-chip').forEach(function (chip) {
                        chip.addEventListener('click', function (e) {
                            e.stopPropagation();
                            var newCat = this.getAttribute('data-cat');
                            if (newCat === recObj.category) return; // å¤‰æ›´ãªã—

                            // è¦‹ãŸç›®ã‚’å³åº§ã«æ›´æ–°
                            ed.querySelectorAll('.cat-chip').forEach(function (c) {
                                c.style.border = '1px solid var(--border-card)';
                                c.style.background = 'transparent';
                                c.style.color = 'var(--text-primary)';
                                c.style.fontWeight = '400';
                            });
                            this.style.border = '2px solid var(--accent-primary)';
                            this.style.background = 'var(--accent-primary)';
                            this.style.color = '#fff';
                            this.style.fontWeight = '700';

                            if (!GAS_API_URL) {
                                showToast('âœ… (ãƒ¢ãƒƒã‚¯) ã‚«ãƒ†ã‚´ãƒªã‚’ã€Œ' + newCat + 'ã€ã«å¤‰æ›´');
                                return;
                            }

                            showToast('ğŸ’¾ ä¿å­˜ä¸­...');
                            callGAS('updateRecord', { rowIndex: ri, category: newCat }, 'POST')
                                .then(function (result) {
                                    if (result.success) {
                                        showToast('âœ… ã‚«ãƒ†ã‚´ãƒªã‚’ã€Œ' + newCat + 'ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ');
                                        recObj.category = newCat;
                                        var newIcon = CATEGORY_ICONS[newCat] || 'ğŸ“¦';
                                        displayDiv.querySelector('.record-icon').innerHTML = newIcon;
                                        displayDiv.querySelector('.record-meta').textContent = recObj.date + ' Â· ' + newCat + ' Â· ' + (recObj.method || '');
                                        setTimeout(function () { loadData(currentYear, currentMonth); }, 800);
                                    } else {
                                        showToast('âŒ ' + result.message, true);
                                    }
                                })
                                .catch(function (err) {
                                    showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼', true);
                                });
                        });
                    });

                    // ãƒ¡ãƒ¢å¤‰æ›´ãƒœã‚¿ãƒ³
                    ed.querySelector('.edit-memo-save').addEventListener('click', function (e) {
                        e.stopPropagation();
                        var newMemo = ed.querySelector('.edit-memo-input').value.trim();
                        if (newMemo === recObj.memo) { showToast('å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

                        if (!GAS_API_URL) {
                            showToast('âœ… (ãƒ¢ãƒƒã‚¯) å“åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                            return;
                        }

                        this.textContent = '...';
                        var btn = this;
                        callGAS('updateRecord', { rowIndex: ri, memo: newMemo }, 'POST')
                            .then(function (result) {
                                btn.textContent = 'å¤‰æ›´';
                                if (result.success) {
                                    showToast('âœ… å“åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                                    recObj.memo = newMemo;
                                    displayDiv.querySelector('.record-memo').textContent = escapeHtml(newMemo);
                                    setTimeout(function () { loadData(currentYear, currentMonth); }, 800);
                                } else { showToast('âŒ ' + result.message, true); }
                            })
                            .catch(function () {
                                btn.textContent = 'å¤‰æ›´';
                                showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼', true);
                            });
                    });
                })(rowIndex, editDiv, rec);

                listEl.appendChild(li);
            });

            showCard('recordsCard');
        }

        // ===== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° =====

        /**
         * æ•°å€¤ã®ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
         */
        function animateNumber(elementId, target) {
            var el = document.getElementById(elementId);
            var current = 0;
            var duration = 800;
            var startTime = null;

            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                var progress = Math.min((timestamp - startTime) / duration, 1);
                // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆease-outï¼‰
                var eased = 1 - Math.pow(1 - progress, 3);
                current = Math.round(eased * target);
                el.textContent = current.toLocaleString();
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }

            requestAnimationFrame(step);
        }

        /**
         * ã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§è¡¨ç¤º
         */
        function showCard(id, delay) {
            var card = document.getElementById(id);
            card.style.display = 'block';
            setTimeout(function () {
                card.classList.add('visible');
            }, delay || 50);
        }

        /**
         * å…¨ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
         */
        function hideAllCards() {
            var cards = document.querySelectorAll('.card');
            cards.forEach(function (card) {
                card.style.display = 'none';
                card.classList.remove('visible');
            });
        }

        /**
         * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
         */
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        /**
         * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
         */
        function onError(err) {
            document.getElementById('loadingState').style.display = 'none';
            console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            var emptyEl = document.getElementById('emptyState');
            emptyEl.querySelector('.empty-icon').textContent = 'âš ï¸';
            emptyEl.querySelector('.empty-message').innerHTML = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ç”»é¢ã‚’æ›´æ–°ã—ã¦ã¿ã¦ãã ã•ã„ã€‚';
            showCard('emptyState');
        }

        function showError(msg) {
            onError(msg);
        }

        // ===== è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ =====

        function renderFixedExpenses() {
            var container = document.getElementById('fixedExpensesList');
            container.innerHTML = '';
            var list = currentSettings.fixedExpenses || [];
            if (list.length === 0) {
                container.innerHTML = '<div style="font-size:0.8rem; color:var(--text-muted); text-align:center; padding:12px; background:#F8FAFC; border-radius:12px;">å›ºå®šè²»ã¯è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            list.forEach(function (item, index) {
                container.appendChild(createFixedExpenseElement(item, index));
            });
        }

        function createFixedExpenseElement(item, index) {
            var row = document.createElement('div');
            row.className = 'fixed-expense-row';
            row.setAttribute('data-index', index);

            var dateSelect = '<select class="fe-date" style="flex: 0 0 54px; padding:8px 2px;">';
            for (var i = 1; i <= 31; i++) {
                var sel = (i == (item.date || 25)) ? 'selected' : '';
                dateSelect += '<option value="' + i + '" ' + sel + '>' + i + 'æ—¥</option>';
            }
            dateSelect += '</select>';

            var currentCatsInput = document.getElementById('settingCategories');
            var catsStr = currentCatsInput ? currentCatsInput.value : currentSettings.categories;
            var cats = catsStr.split(',').map(c => c.trim()).filter(c => c);
            var catSelect = '<select class="fe-category" style="width: 70px;">';
            var hasSavedCat = false;
            cats.forEach(c => {
                var sel = (c === (item.category || 'æœªåˆ†é¡')) ? 'selected' : '';
                if (sel) hasSavedCat = true;
                catSelect += '<option value="' + c + '" ' + sel + '>' + c + '</option>';
            });
            if (!hasSavedCat && item.category) {
                catSelect += '<option value="' + escapeHtml(item.category) + '" selected>' + escapeHtml(item.category) + '</option>';
            }
            catSelect += '</select>';

            row.innerHTML =
                dateSelect +
                '<input type="text" class="fe-memo" style="flex:1; min-width:60px;" placeholder="å“å(ä¾‹:å®¶è³ƒ)" value="' + escapeHtml(item.memo || '') + '">' +
                catSelect +
                '<input type="number" class="fe-amount" style="width:70px;" placeholder="é‡‘é¡" value="' + (item.amount || '') + '">' +
                '<button class="del-btn" onclick="removeFixedExpenseRow(this)">Ã—</button>';
            return row;
        }

        function addFixedExpenseRow() {
            if (!currentSettings.fixedExpenses) currentSettings.fixedExpenses = [];
            currentSettings.fixedExpenses.push({ date: 25, memo: '', category: 'æœªåˆ†é¡', amount: '' });
            renderFixedExpenses();
        }

        function removeFixedExpenseRow(btnEl) {
            var row = btnEl.closest('.fixed-expense-row');
            var index = row.getAttribute('data-index');
            currentSettings.fixedExpenses.splice(index, 1);
            renderFixedExpenses();
        }

        function gatherFixedExpenses() {
            var list = [];
            document.querySelectorAll('.fixed-expense-row').forEach(function (row) {
                var date = row.querySelector('.fe-date').value;
                var memo = row.querySelector('.fe-memo').value.trim();
                var cat = row.querySelector('.fe-category').value;
                var amount = row.querySelector('.fe-amount').value;
                if (memo && amount) {
                    list.push({ date: parseInt(date), memo: memo, category: cat, amount: parseInt(amount) });
                }
            });
            return list;
        }

        function renderAccounts() {
            var container = document.getElementById('accountsList');
            container.innerHTML = '';
            var list = currentSettings.accounts || [];
            if (list.length === 0) {
                container.innerHTML = '<div style="font-size:0.8rem; color:var(--text-muted); text-align:center; padding:12px; background:#F8FAFC; border-radius:12px;">å£åº§ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            list.forEach(function (item, index) {
                container.appendChild(createAccountElement(item, index));
            });
        }

        function createAccountElement(item, index) {
            var row = document.createElement('div');
            row.className = 'fixed-expense-row'; // å›ºå®šè²»ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æµç”¨
            row.setAttribute('data-index', index);

            row.innerHTML =
                '<input type="text" class="ac-name" style="flex:2; min-width:80px;" placeholder="å£åº§ãƒ»ã‚«ãƒ¼ãƒ‰å" value="' + escapeHtml(item.name || '') + '">' +
                '<input type="number" class="ac-balance" style="flex:1; width:80px;" placeholder="ç¾åœ¨æ®‹é«˜" value="' + (item.balance || '') + '">' +
                '<span style="font-size:0.8rem; color:var(--text-muted);">å††</span>' +
                '<button class="del-btn" onclick="removeAccountRow(this)">Ã—</button>';
            return row;
        }

        function addAccountRow() {
            if (!currentSettings.accounts) currentSettings.accounts = [];
            currentSettings.accounts.push({ name: '', balance: 0 });
            renderAccounts();
        }

        function removeAccountRow(btnEl) {
            var row = btnEl.closest('.fixed-expense-row');
            var index = row.getAttribute('data-index');
            currentSettings.accounts.splice(index, 1);
            renderAccounts();
        }

        function gatherAccounts() {
            var list = [];
            var rows = document.querySelectorAll('#accountsList .fixed-expense-row');
            if (rows && rows.length > 0) {
                rows.forEach(function (row) {
                    var nameInput = row.querySelector('.ac-name');
                    var balanceInput = row.querySelector('.ac-balance');
                    if (nameInput && balanceInput) {
                        var name = nameInput.value.trim();
                        var balance = balanceInput.value;
                        if (name) {
                            // å…¥åŠ›ãŒãªã„å ´åˆã‚„ç„¡åŠ¹ãªå ´åˆã¯0å††ã¨ã™ã‚‹
                            list.push({ name: name, balance: parseInt(balance) || 0 });
                        }
                    }
                });
            }
            return list;
        }

        document.getElementById('settingCategories').addEventListener('blur', function () {
            currentSettings.fixedExpenses = gatherFixedExpenses();
            renderFixedExpenses();
        });

        function openSettingsModal() {
            var modal = document.getElementById('settingsModal');
            var overlay = document.getElementById('settingsOverlay');

            document.getElementById('settingBudget').value = currentSettings.budget;
            document.getElementById('settingCategories').value = currentSettings.categories;

            renderFixedExpenses();
            renderAccounts();

            modal.classList.add('active');
            overlay.classList.add('active');
        }

        function closeSettingsModal() {
            var modal = document.getElementById('settingsModal');
            var overlay = document.getElementById('settingsOverlay');
            modal.classList.remove('active');
            overlay.classList.remove('active');
        }

        function saveSettings() {
            var newBudget = document.getElementById('settingBudget').value;
            var newCats = document.getElementById('settingCategories').value;
            var newFx = gatherFixedExpenses();
            var newAcc = gatherAccounts();

            if (!newBudget || !newCats) {
                showToast('äºˆç®—ã¨ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }

            var btn = document.getElementById('saveSettingsBtn');
            var originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ä¿å­˜ä¸­...';

            var fxStr = JSON.stringify(newFx);
            var accStr = JSON.stringify(newAcc);

            if (!GAS_API_URL && typeof google === 'undefined') {
                setTimeout(function () {
                    currentSettings.budget = parseInt(newBudget);
                    currentSettings.categories = newCats;
                    currentSettings.fixedExpenses = newFx;
                    currentSettings.accounts = newAcc;
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    closeSettingsModal();
                    showToast('âœ… (Local) è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚å£åº§æ•°:' + newAcc.length);
                    loadData(currentYear, currentMonth); // å†æç”»
                }, 800);
                return;
            }

            callGAS('saveSettings', {
                budget: newBudget,
                categories: newCats,
                fixedCosts: fxStr,
                accounts: accStr
            }, 'POST')
                .then(function (res) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    if (res.success) {
                        currentSettings.budget = parseInt(newBudget);
                        currentSettings.categories = newCats;
                        currentSettings.fixedExpenses = newFx;
                        currentSettings.accounts = newAcc;
                        closeSettingsModal();
                        showToast('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                        loadData(currentYear, currentMonth); // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å†æç”»
                    } else {
                        showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + res.error, true);
                    }
                })
                .catch(function (err) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
                });
        }

        // ===== å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ =====

        var selectedCategory = 'æœªåˆ†é¡';

        /**
         * å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰
         */
        function toggleInputModal() {
            var modal = document.getElementById('inputModal');
            var overlay = document.getElementById('modalOverlay');
            var fab = document.getElementById('fabBtn');
            var isOpen = modal.classList.contains('active');

            if (isOpen) {
                modal.classList.remove('active');
                overlay.classList.remove('active');
                fab.classList.remove('open');
            } else {
                modal.classList.add('active');
                overlay.classList.add('active');
                fab.classList.add('open');

                // ç¾åœ¨ã®ã‚«ãƒ†ã‚´ãƒªè¨­å®šãƒªã‚¹ãƒˆã‚’ã‚‚ã¨ã«ã€ãƒãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
                var chipsContainer = document.getElementById('categoryChips');
                var catArray = currentSettings.categories.split(',').map(c => c.trim()).filter(c => c);
                if (catArray.length > 0) {
                    chipsContainer.innerHTML = '';
                    catArray.forEach(function (catName, index) {
                        var icon = CATEGORY_ICONS[catName] || 'ğŸ·ï¸';
                        var isSelected = (index === 0) ? 'selected' : '';
                        if (index === 0) selectedCategory = catName; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«

                        var btn = document.createElement('button');
                        btn.className = 'chip ' + isSelected;
                        btn.setAttribute('data-cat', catName);
                        btn.innerHTML = icon + ' ' + escapeHtml(catName);
                        btn.onclick = function () { selectCategory(this); };
                        chipsContainer.appendChild(btn);
                    });
                }

                // æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®šï¼ˆå€¤ãŒç©ºã®å ´åˆã®ã¿ï¼‰
                var dateInput = document.getElementById('inputDate');
                if (!dateInput.value) {
                    var today = new Date();
                    var yyyy = today.getFullYear();
                    var mm = String(today.getMonth() + 1).padStart(2, '0');
                    var dd = String(today.getDate()).padStart(2, '0');
                    dateInput.value = yyyy + '-' + mm + '-' + dd;
                }

                // å£åº§ã‚»ãƒ¬ã‚¯ãƒˆã®èª¿æ•´
                var accounts = currentSettings.accounts || [];
                ['expenseAccount', 'incomeAccount', 'transferFromAccount'].forEach(function (selId) {
                    var sel = document.getElementById(selId);
                    if (sel) {
                        sel.innerHTML = '<option value="">â€•â€• å£åº§ã‚’é¸æŠ â€•â€•</option>';
                        accounts.forEach(function (acc) {
                            var opt = document.createElement('option');
                            opt.value = acc.name;
                            opt.textContent = acc.name;
                            sel.appendChild(opt);
                        });
                    }
                });

                // å“åå…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                setTimeout(function () {
                    document.getElementById('inputMemo').focus();
                }, 350);
            }
        }

        /**
         * å…¥åŠ›ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆï¼ˆæ”¯å‡ºãƒ»åå…¥ãƒ»æŒ¯æ›¿ï¼‰
         */
        var currentInputType = 'expense';
        function switchInputType(type) {
            currentInputType = type;
            var tabs = ['expense', 'income', 'transfer'];
            tabs.forEach(function (t) {
                var tabEl = document.getElementById('tab-' + t);
                if (tabEl) tabEl.classList.toggle('selected', t === type);
            });
            document.getElementById('expenseFields').style.display = type === 'expense' ? 'block' : 'none';
            document.getElementById('incomeFields').style.display = type === 'income' ? 'block' : 'none';
            document.getElementById('transferFields').style.display = type === 'transfer' ? 'block' : 'none';

            var titleMap = { expense: 'âœï¸ æ”¯å‡ºã‚’è¨˜éŒ²', income: 'ğŸ’° åå…¥ã‚’è¨˜éŒ²', transfer: 'ğŸ¦ æŒ¯æ›¿ï¼ˆè²¯è“„ï¼‰ã‚’è¨˜éŒ²' };
            document.getElementById('modalTitle').textContent = titleMap[type] || 'è¨˜éŒ²';
        }

        /**
         * ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ—ã®é¸æŠ
         */
        function selectCategory(el) {
            document.querySelectorAll('.chip').forEach(function (c) {
                c.classList.remove('selected');
            });
            el.classList.add('selected');
            selectedCategory = el.getAttribute('data-cat');
        }

        /**
         * æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡
         */
        function submitExpense() {
            var memo = document.getElementById('inputMemo').value.trim();
            var amount = document.getElementById('inputAmount').value.trim();
            var dateVal = document.getElementById('inputDate').value;
            var dateStr = dateVal ? dateVal.replace(/-/g, '/') : '';

            // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚«ãƒ†ã‚´ãƒªãƒ»å£åº§ã®å–å¾—
            var type = currentInputType;
            var cat = (type === 'income') ? 'åå…¥' : (type === 'transfer') ? 'æŒ¯æ›¿' : selectedCategory;
            var accountSel = (type === 'income')
                ? document.getElementById('incomeAccount')
                : (type === 'transfer') ? document.getElementById('transferFromAccount')
                    : document.getElementById('expenseAccount');
            var account = accountSel ? accountSel.value : '';
            var typeLabel = (type === 'income') ? 'åå…¥' : (type === 'transfer') ? 'æŒ¯æ›¿' : 'æ”¯å‡º';

            if (!memo) {
                showToast('å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            if (!amount || parseInt(amount) <= 0) {
                showToast('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }

            var btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'è¨˜éŒ²ä¸­...';

            if (!GAS_API_URL && typeof google === 'undefined') {
                setTimeout(function () {
                    btn.disabled = false;
                    btn.textContent = 'è¨˜éŒ²ã™ã‚‹ ğŸ“';
                    showToast('âœ… (Localãƒ¢ãƒƒã‚¯) ' + memo + ': Â¥' + amount + ' ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ (' + typeLabel + ')');
                    document.getElementById('inputMemo').value = '';
                    document.getElementById('inputAmount').value = '';
                    toggleInputModal();
                }, 800);
                return;
            }

            callGAS('addExpense', {
                memo: memo,
                amount: amount,
                category: cat,
                date: dateStr,
                account: account,
                type: typeLabel
            }, 'POST')
                .then(function (result) {
                    btn.disabled = false;
                    btn.textContent = 'è¨˜éŒ²ã™ã‚‹ ğŸ“';

                    if (result.success) {
                        showToast('âœ… ' + result.message);
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ (æ—¥ä»˜ä»¥å¤–)
                        document.getElementById('inputMemo').value = '';
                        document.getElementById('inputAmount').value = '';
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                        toggleInputModal();
                        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                        setTimeout(function () { loadData(currentYear, currentMonth); }, 500);
                    } else {
                        showToast('âŒ ' + result.message, true);
                    }
                })
                .catch(function (err) {
                    btn.disabled = false;
                    btn.textContent = 'è¨˜éŒ²ã™ã‚‹ ğŸ“';
                    showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
                });
        }

        /**
         * å…¨ä»¶è¡¨ç¤ºï¼ˆGASã‹ã‚‰æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºï¼‰
         */
        function loadAllRecords() {
            var btn = document.getElementById('loadAllRecordsBtn');
            btn.textContent = 'èª­è¾¼ä¸­...';
            btn.disabled = true;

            if (!GAS_API_URL && typeof google === 'undefined') {
                setTimeout(function () {
                    btn.textContent = 'å…¨ä»¶è¡¨ç¤º';
                    btn.disabled = false;
                    showToast('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§ã¯å…¨ä»¶è¡¨ç¤ºã§ãã¾ã›ã‚“', true);
                }, 500);
                return;
            }

            callGAS('getMonthlyRecords', { year: currentYear, month: currentMonth + 1 })
                .then(function (result) {
                    btn.textContent = 'å…¨ä»¶è¡¨ç¤º';
                    btn.disabled = false;
                    if (result.success) {
                        renderRecords(result.records);
                        showToast('ğŸ“‹ ' + result.records.length + 'ä»¶ã®è¨˜éŒ²ã‚’è¡¨ç¤º');
                    } else {
                        showToast('âŒ ' + result.message, true);
                    }
                })
                .catch(function (err) {
                    btn.textContent = 'å…¨ä»¶è¡¨ç¤º';
                    btn.disabled = false;
                    showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼', true);
                });
        }

        /**
         * ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
         */
        function showToast(message, isError) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(function () {
                toast.className = 'toast';
            }, 3000);
        }

        /**
         * ğŸ’¡ AIåˆ†æã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
         */
        function requestAiAnalysis() {
            var btn = document.querySelector('button[title="AIã§åˆ†æã™ã‚‹"]');
            var loadingSpan = document.getElementById('aiAnalysisLoading');
            var card = document.getElementById('aiAdviceCard');
            var msgArea = document.getElementById('aiMessageText');

            if (btn) btn.disabled = true;
            if (loadingSpan) loadingSpan.style.display = 'inline';
            if (msgArea) msgArea.textContent = 'éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚„äºˆç®—è¨­å®šã‹ã‚‰ã€å°‚å±ã‚¢ãƒŠãƒªã‚¹ãƒˆãŒåˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã„ã¾ã™... (ç´„10ã€œ20ç§’ã‹ã‹ã‚Šã¾ã™) ğŸ¤–ğŸ’­';
            card.style.display = 'block';

            if (!GAS_API_URL && typeof google === 'undefined') {
                setTimeout(function () {
                    if (btn) btn.disabled = false;
                    if (loadingSpan) loadingSpan.style.display = 'none';
                    msgArea.textContent = "ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¢åˆ†æçµæœã€‘\n\nãƒ»é£Ÿè²»ãŒå…ˆæœˆæ¯”ã§+15%ãƒšãƒ¼ã‚¹ã§é€²è¡Œã—ã¦ã„ã¾ã™ã€‚ä»Šé€±æœ«ã®å¤–é£Ÿã¯æ§ãˆã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚\nãƒ»ã“ã®ãƒšãƒ¼ã‚¹ã ã¨æœˆæœ«ã«äºˆç®—ã‚’ç´„8,000å††è¶…éã™ã‚‹è¦‹è¾¼ã¿ã§ã™ã€‚æµªè²»ãƒã‚¤ãƒ³ãƒˆã¯ã€Œäº¤éš›è²»ã€ã€Œå¨¯æ¥½è²»ã€ã§ã™ã€‚";
                    showToast('âœ… åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ');
                }, 2000);
                return;
            }

            callGAS('getAiAnalysis', { isWeekly: false }) // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã¯ä¸€æ—¦æœˆæ¬¡ãƒ™ãƒ¼ã‚¹ã®åˆ†æã‚’ã‚³ãƒ¼ãƒ«
                .then(function (result) {
                    if (btn) btn.disabled = false;
                    if (loadingSpan) loadingSpan.style.display = 'none';
                    if (result.success) {
                        msgArea.textContent = result.analysis;
                        showToast('âœ… AIåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ');
                    } else {
                        msgArea.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + result.message;
                        showToast('âŒ ' + result.message, true);
                    }
                })
                .catch(function (err) {
                    if (btn) btn.disabled = false;
                    if (loadingSpan) loadingSpan.style.display = 'none';
                    msgArea.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                    showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼', true);
                });
        }

        /**
         * è¡¨ç¤ºã™ã‚‹æœˆã‚’å¤‰æ›´ã™ã‚‹
         */
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            loadData(currentYear, currentMonth);
        }

        // ===== åˆæœŸåŒ– =====
        window.addEventListener('DOMContentLoaded', function () {
            // ç¾åœ¨ã®å¹´æœˆã§åˆæœŸãƒ­ãƒ¼ãƒ‰
            loadData(currentYear, currentMonth);
        });
    </script>
</body>

</html>